{% extends 'base.html' %}

{% block title %}Temps Réel – Device {{ device.name }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <h5 class="mb-3">📂 Menu - {{ device.name }}</h5>
            <div class="list-group">
                <a href="{{ url_for('mesures.realtime', device_id=device.id) }}" class="list-group-item list-group-item-action">📡 Temps Réel</a>
                <a href="{{ url_for('mesures.history', device_id=device.id) }}" class="list-group-item list-group-item-action">📜 Historique</a>
                <a href="{{ url_for('mesures.esp_code', device_id=device.id) }}" class="list-group-item list-group-item-action">⚙️ Code ESP</a>
                <a href="{{ url_for('devices.list_devices') }}" class="list-group-item list-group-item-action">🔙 Retour</a>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="col-md-9">
        <div class="container mt-4">
            <h2>Données en temps réel – Device {{ device.name }}</h2>

            <div class="card my-3 shadow p-3">
                <h4>Mesures</h4>
                <canvas id="lineChart" height="250"></canvas>
            </div>

            {% if 'kilometrage' in data %}
            <div class="card my-3 shadow p-3">
                <h4>Kilométrage</h4>
                <canvas id="barChart" height="250"></canvas>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ✅ Import Chart.js + Socket.IO -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// Connect to Socket.IO server
const socket = io();

// Convert Flask data to JS
const data = {{ data | tojson }};
console.log("Initial data:", data);

const lineLabels = [];
const datasets = [];
const barLabels = [];
const kmData = [];

// Initialize datasets
Object.keys(data).forEach((capability, idx) => {
    const values = data[capability];
    if (capability !== 'kilometrage') {
        const yData = values.map(v => v.value);
        const xLabels = values.map(v => v.timestamp || '');
        if (lineLabels.length === 0) xLabels.forEach(label => lineLabels.push(label));

        datasets.push({
            label: capability.charAt(0).toUpperCase() + capability.slice(1),
            data: yData,
            borderColor: `hsl(${idx * 60}, 70%, 50%)`,
            backgroundColor: `hsla(${idx * 60}, 70%, 50%, 0.2)`,
            fill: false,
            tension: 0.2
        });
    } else {
        values.forEach(v => {
            barLabels.push(v.timestamp || '');
            kmData.push(v.value);
        });
    }
});

// --- Initialize Charts ---
const ctxLine = document.getElementById('lineChart').getContext('2d');
window.lineChart = new Chart(ctxLine, {
    type: 'line',
    data: { labels: lineLabels, datasets: datasets },
    options: { responsive: true, plugins: { legend: { position: 'top' } } }
});

let barChart;
if (kmData.length > 0) {
    const ctxBar = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: barLabels,
            datasets: [{
                label: 'Kilométrage (m)',
                data: kmData,
                backgroundColor: 'rgba(255,206,86,0.7)',
                borderColor: 'rgba(255,206,86,1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });
}

// --- Listen for new measurements ---
socket.on('new_measurement', msg => {
    if (msg.device_id !== {{ device.id }}) return; // ignore other devices
    const { capability, value, timestamp } = msg;
    console.log("New measurement:", msg);

    if (capability !== 'kilometrage') {
        let dataset = datasets.find(d => d.label.toLowerCase() === capability.toLowerCase());
        if (!dataset) {
            dataset = {
                label: capability.charAt(0).toUpperCase() + capability.slice(1),
                data: [],
                borderColor: `hsl(${datasets.length * 60}, 70%, 50%)`,
                backgroundColor: `hsla(${datasets.length * 60}, 70%, 50%, 0.2)`,
                fill: false,
                tension: 0.2
            };
            datasets.push(dataset);
            lineChart.data.datasets.push(dataset);
        }
        dataset.data.push(value);
        lineChart.data.labels.push(timestamp);  // ✅ correction
        lineChart.update();
    } else if (barChart) {
        barChart.data.labels.push(timestamp);   // ✅ correction
        barChart.data.datasets[0].data.push(value);
        barChart.update();
    }
});

</script>

{% endblock %}
