{% extends 'base.html' %}

{% block title %}Historique – Device {{ device.name }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <h5 class="mb-3">📂 Menu - {{ device.name }}</h5>
            <div class="list-group">
                <a href="{{ url_for('mesures.realtime', device_id=device.id) }}" class="list-group-item list-group-item-action">📡 Temps Réel</a>
                <a href="{{ url_for('mesures.history', device_id=device.id) }}" class="list-group-item list-group-item-action">📜 Historique</a>
                <a href="{{ url_for('mesures.esp_code', device_id=device.id) }}" class="list-group-item list-group-item-action">⚙️ Code ESP</a>
                <a href="{{ url_for('devices.list_devices') }}" class="list-group-item list-group-item-action">🔙 Retour</a>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="col-md-9">
        <div class="container mt-4">
            <h2>Historique des mesures – Device {{ device.name }}</h2>

            <!-- Line chart -->
            <div class="card my-3 shadow p-3">
                <h4>Mesures</h4>
                <canvas id="lineChart" height="250"></canvas>
            </div>

            <!-- Bar chart for Kilométrage -->
            {% if 'kilometrage' in data %}
            <div class="card my-3 shadow p-3">
                <h4>Kilométrage</h4>
                <canvas id="barChart" height="250"></canvas>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Convertir les données Flask en JS
const data = {{ data | tojson }};
console.log("Data reçue:", data);

const lineLabels = [];
const datasets = [];
const barLabels = [];
const kmData = [];

// Création des datasets dynamiquement
Object.keys(data).forEach((capability, idx) => {
    const values = data[capability];
    if (capability !== 'kilometrage') {
        const yData = values.map(v => v.value);
        const xLabels = values.map(v => v.timestamp || '');

        // Remplir lineLabels uniquement si vide (pour éviter les doublons)
        if (lineLabels.length === 0) {
            xLabels.forEach(label => lineLabels.push(label));
        }

        datasets.push({
            label: capability.charAt(0).toUpperCase() + capability.slice(1),
            data: yData,
            borderColor: `hsl(${idx * 60}, 70%, 50%)`,
            backgroundColor: `hsla(${idx * 60}, 70%, 50%, 0.2)`,
            fill: false,
            tension: 0.2
        });
    } else {
        values.forEach(v => {
            barLabels.push(v.timestamp || '');
            kmData.push(v.value);
        });
    }
});

// --- Line chart ---
if (datasets.length > 0) {
    const ctxLine = document.getElementById('lineChart').getContext('2d');
    new Chart(ctxLine, {
        type: 'line',
        data: { labels: lineLabels, datasets: datasets },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { x: { display: true }, y: { display: true } }
        }
    });
}

// --- Bar chart ---
if (kmData.length > 0) {
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: barLabels,
            datasets: [{
                label: 'Kilométrage (m)',
                data: kmData,
                backgroundColor: 'rgba(255,206,86,0.7)',
                borderColor: 'rgba(255,206,86,1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { x: { display: true }, y: { display: true } }
        }
    });
}
</script>
{% endblock %}